<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Gielinor | Clan Stats</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/@antv/g2plot@latest/dist/g2plot.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="clan_data.js"></script>
    <script src="ai_data.js"></script>
    <!-- Removed deferred logic, moved to body end -->

    <!-- NEW: Styling Libraries (Production Integration) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.1/vanilla-tilt.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- CountUp.js must be a module or standard script. Using CDN that exposes global for simplicity if available, else module in logic. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/countup.js/2.0.7/countUp.min.js"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Outfit:wght@300;400;600&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="assets/styles.css">
    <link rel="stylesheet" href="assets/dynamic_styles.css">
</head>

<body>
    <div id="particles-js" style="position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: -1;"></div>
    <div class="container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="sidebar-title">CLAN<br>STATS</div>
            <div class="nav-item active" data-tab="general" onclick="switchSection('general')">General</div>
            <div class="nav-item" data-tab="outliers" onclick="switchSection('outliers')">Purging</div>
            <div class="nav-item" data-tab="messages" onclick="switchSection('messages')">Messages</div>
            <div class="nav-item" data-tab="bosses" onclick="switchSection('bosses')">Bosses</div>
            <div class="nav-item" data-tab="xp-gains" onclick="switchSection('xp-gains')">XP Gains</div>
            <div class="nav-item" data-tab="ai-insights" onclick="switchSection('ai-insights')">AI Insights</div>
            <div class="nav-item" data-tab="roster" onclick="switchSection('roster')"><i class="fas fa-users"></i>Full
                Roster</div>
        </div>
        <!-- Main Content -->
        <div class="main-content">
            <!-- General Section -->
            <div id="general" class="section active">
                <div class="header">
                    <h1>General</h1>
                    <div class="header-right">
                        <div class="header-info">Updated: <span id="updated-time">loading...</span></div>
                        <a href="clan_data.csv" class="download-btn" download>
                            <span class="icon">üìÑ</span> CSV
                        </a>
                        <input type="text" class="search-box" id="search-general" placeholder="Search player...">
                    </div>
                </div>
                <!-- WEEKLY INTELLIGENCE BRIEFING (PULSE TICKER) -->
                <!-- WEEKLY INTELLIGENCE BRIEFING (PULSE TICKER) -->
                <div class="news-card">
                    <div class="news-label"><i class="fas fa-satellite-dish"></i> CLAN PULSE:</div>
                    <div class="news-ticker-wrapper">
                        <div id="news-ticker" class="news-ticker-content">
                            <span class="loading">Establishing sat-link...</span>
                        </div>
                    </div>
                </div>

                <!-- CONTROL BAR (TIMEFRAME TOGGLES) -->
                <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                    <div class="glass-card" style="padding: 5px; display: inline-flex; gap: 5px;">
                        <button class="time-toggle active" onclick="switchTimeframe('7d')" id="btn-7d">7 Days</button>
                        <button class="time-toggle" onclick="switchTimeframe('30d')" id="btn-30d">30 Days</button>
                    </div>
                </div>

                <div class="stats-grid" id="general-stats">
                    <div class="stat-card" id="card-top-msg">
                        <div class="stat-label">Top Messenger <span class="trend-indicator" id="trend-msg"></span></div>
                        <div class="stat-value" id="stat-top-msg">Loading...</div>
                    </div>
                    <div class="stat-card" id="card-top-xp">
                        <div class="stat-label">Top XP Gained <span id="lbl-xp-period">(7d)</span> <span
                                class="trend-indicator" id="trend-xp"></span></div>
                        <div class="stat-value" id="stat-top-xp">Loading...</div>
                    </div>
                    <div class="stat-card" id="card-rising-star">
                        <div class="stat-label">Rising Star</div>
                        <div class="stat-value" id="stat-rising-star">Loading...</div>
                    </div>
                    <div class="stat-card" id="card-top-boss">
                        <div class="stat-label">Top Boss Killer</div>
                        <div class="stat-value" id="stat-top-boss">Loading...</div>
                    </div>
                    <div class="stat-card" id="card-active-members">
                        <div class="stat-label">Active Members <span id="lbl-active-period">(30d)</span></div>
                        <div class="stat-value" id="stat-active-members">Loading...</div>
                    </div>
                </div>

                <!-- MODERATION ALERTS (ALERT CARDS) -->
                <div class="section-container">
                    <div class="section-title"><i class="fas fa-exclamation-triangle"></i> Strategic Alerts</div>
                    <div id="alert-cards-container" class="alert-grid">
                        <!-- Dynamic Alert Cards will be injected here -->
                        <div class="glass-card neon-border-red" style="padding: 20px; text-align: center;">
                            <div class="stat-label">Scanning for Risks...</div>
                        </div>
                    </div>
                </div>


                <!-- NEW CHARTS SECTION (Replaces Bingo) -->
                <div class="section-container">
                    <div class="section-title"><i class="fas fa-chart-pie"></i> Performance Analytics</div>

                    <!-- Row 1: Scatter (Full Width) -->
                    <div class="chart-container" style="margin-bottom: 24px;">
                        <div class="chart-title">"Chatterboxes" vs "Grinders" (Activity Matrix)</div>
                        <div class="chart-wrapper" style="height: 400px;">
                            <div id="container-scatter-interaction"></div>
                        </div>
                    </div>

                    <!-- Row 2: Bossing Diversity (Full Width - 4x size) -->
                    <div class="chart-container" style="margin-bottom: 24px;">
                        <div class="chart-title">Bossing Diversity</div>
                        <div class="chart-wrapper" style="height: 500px;"> <!-- Increased height for 4x impact -->
                            <div id="container-boss-diversity"></div>
                        </div>
                    </div>

                    <!-- Row 3: Raids & Skill Mastery -->
                    <div class="dual-chart">
                        <div class="chart-item">
                            <div class="chart-item-title">Raids Preference</div>
                            <div class="chart-wrapper">
                                <canvas id="chart-raids-performance"></canvas>
                            </div>
                        </div>

                        <!-- Row 3: Skill Mastery & Trending Boss -->
                        <div class="dual-chart">
                            <div class="chart-item">
                                <div class="chart-item-title">Clan Skill Mastery (99s)</div>
                                <div class="chart-wrapper">
                                    <canvas id="chart-skill-mastery"></canvas>
                                </div>
                            </div>
                            <div class="chart-item">
                                <div class="chart-item-title">
                                    Boss of the Month: <span id="trending-boss-name"
                                        style="color: var(--neon-gold);">...</span>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="chart-boss-trend"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="dual-chart">
                        <div class="chart-item">
                            <div class="chart-item-title">Clan Activity Health</div>
                            <div class="chart-wrapper"><canvas id="activity-health-chart"></canvas>
                            </div>
                        </div>
                        <div class="chart-item">
                            <div class="chart-item-title">Top XP Contributors (7d)</div>
                            <div class="chart-wrapper"><canvas id="top-xp-contributors-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="dual-chart">
                        <!-- Activity Trend -->
                        <div class="chart-item">
                            <div class="chart-item-title"><i class="fas fa-chart-line"></i> Weekly Activity Trend</div>
                            <div class="chart-wrapper">
                                <div id="container-activity-trend"></div>
                            </div>
                        </div>
                        <!-- New: Tenure Distribution -->
                        <div class="chart-item">
                            <div class="chart-item-title"><i class="fas fa-users-cog"></i> Clan Loyalty (Tenure)</div>
                            <div class="chart-wrapper">
                                <canvas id="tenure-distribution-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title"><i class="fas fa-trophy"></i>Top 10 Leaderboard
                            (Composite Score) </div>
                        <div class="chart-wrapper"><canvas id="leaderboard-chart"></canvas></div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Recent Activity (7 Days)</div>
                        <div class="table-container" style="padding: 0;">
                            <table id="recent-activity-table">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Player</th>
                                        <th>Messages</th>
                                        <th>XP Gained</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="4" class="loading">
                                            <div class="spinner"></div>Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="inactive-alert">
                        <div class="alert-title">‚ö†Ô∏è Inactive Watchlist (0 Msgs in 30d)</div>
                        <div class="inactive-tags" id="inactive-watchlist">
                            <div class="loading">
                                <div class="spinner"></div>Loading...
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Messages Section -->
            <div id="messages" class="section">
                <div class="header">
                    <h1>Messages</h1>
                    <div style="text-align: right;">
                        <div class="header-info">Updated: <span id="updated-time-msg">loading...</span></div><input
                            type="text" class="search-box" id="search-messages" placeholder="Search player...">
                    </div>
                </div>
                <div class="dual-chart">
                    <div class="chart-item">
                        <div class="chart-item-title">Message Volume (Top 5)</div>
                        <div class="chart-wrapper"><canvas id="message-volume-chart"></canvas></div>
                    </div>
                    <div class="chart-item">
                        <div class="chart-item-title"><i class="fas fa-chart-pie"></i>Role
                            Distribution</div>
                        <div class="chart-wrapper"><canvas id="role-distribution-chart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title"><i class="fas fa-th"></i>Activity Heatmap
                        (Hourly)</div>
                    <div class="chart-wrapper" style="min-height: 200px;">
                        <div id="activity-heatmap" style="width:100%; height:100%;"></div>
                    </div>
                </div>
                <div class="table-container">
                    <table id="messages-table">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th>Role</th>
                                <th>Total Messages</th>
                                <th>Last 7 Days</th>
                                <th>Last 30 Days</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="loading">
                                    <div class="spinner"></div>Loading...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- XP Gains Section -->
            <div id="xp-gains" class="section">
                <div class="header">
                    <h1>XP Gains</h1>
                    <div style="text-align: right;">
                        <div class="header-info">Updated: <span id="updated-time-xp">loading...</span></div><input
                            type="text" class="search-box" id="search-xp" placeholder="Search player...">
                    </div>
                </div>
                <div class="dual-chart">
                    <div class="chart-item">
                        <div class="chart-item-title">XP Gains (7d) vs Total XP</div>
                        <div class="chart-wrapper"><canvas id="xp-7d-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-item">
                        <div class="chart-item-title">Top 25 Annualized XP Contribution</div>
                        <div class="chart-wrapper" id="xp-contribution-chart"></div>
                        <!-- Changed from Player Radar Canvas to DIV -->
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title"><i class="fas fa-chart-line"></i> Weekly Correlation (XP vs Msgs)</div>
                    <div class="chart-wrapper" id="container-xp-scatter"></div>
                </div>
                <div class="table-container">
                    <table id="xp-table">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th>Role</th>
                                <th>Total XP</th>
                                <th>XP Gained (7d)</th>
                                <th>XP Gained (30d)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="loading">
                                    <div class="spinner"></div>Loading...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Outliers Section -->
            <div id="outliers" class="section">
                <div class="header">
                    <h1>Purging Candidates</h1>
                    <div style="text-align: right;">
                        <div class="header-info">Updated: <span id="updated-time-out">loading...</span></div><input
                            type="text" class="search-box" id="search-outliers" placeholder="Search player...">
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Inactive & Low Performance Members</div>
                    <div class="table-container" style="padding: 0;">
                        <table id="outliers-table">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    <th>Role</th>
                                    <th>Messages (30d)</th>
                                    <th>XP Gain (30d)</th>
                                    <th>Joined</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="loading">
                                        <div class="spinner"></div>Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Roster Section -->
            <div id="roster" class="section">
                <div class="header">
                    <h1>Full Roster</h1>
                    <div style="text-align: right;"><input type="text" class="search-box" id="search-roster"
                            placeholder="Search player..."></div>
                </div>
                <div class="table-container">
                    <table id="roster-table" class="sortable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)">Player <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(1)">XP (7d) <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(2)">XP (Total) <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(3)">Boss (7d) <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(4)">Boss (Total) <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(5)">Msgs (7d) <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(6)">Msgs (Total) <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(7)">Ratio <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(8)">Days <i class="fas fa-sort"></i></th>
                            </tr>
                        </thead>
                        <tbody id="roster-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Bosses Section -->
            <div id="bosses" class="section">
                <div class="header">
                    <h1>Boss Activity</h1>
                    <div style="text-align: right;">
                        <div class="header-info">Updated: <span id="updated-time-boss">loading...</span>
                        </div><input type="text" class="search-box" id="search-bosses" placeholder="Search player...">
                    </div>
                </div>
                <!-- New Boss Cards -->
                <div class="stats-grid" id="boss-cards">
                    <div class="loading">Loading boss highlights...
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Boss Killers Leaderboard
                    </div>
                    <div class="table-container" style="padding: 0;">
                        <table id="bosses-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Player</th>
                                    <th>Role</th>
                                    <th>Total Kills</th>
                                    <th>Kills (7d)</th>
                                    <th>Kills (30d)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="loading">
                                        <div class="spinner"></div>
                                        Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


            <!-- AI Insights Section -->
            <div id="ai-insights" class="section">
                <div class="header">
                    <h1>AI Insights</h1>
                    <div style="text-align: right;">
                        <div class="header-info">Updated: <span id="updated-time-ai">loading...</span></div>
                    </div>
                </div>
                <div id="ai-insights-container" class="alert-grid">
                    <!-- Dynamic AI Insights will be injected here -->
                    <div class="glass-card neon-border-blue" style="padding: 20px; text-align: center;">
                        <div class="stat-label">Analyzing Clan Data...</div>
                    </div>
                </div>
            </div>

            <!-- OMNI-SEARCH MODAL -->
            <div id="omni-search-overlay" class="omni-overlay" onclick="if(event.target===this) toggleOmni()">
                <div class="omni-modal">
                    <div class="omni-header">
                        <i class="fas fa-search omni-icon"></i>
                        <input type="text" id="omni-input" placeholder="Jump to player, boss, or section..."
                            autocomplete="off">
                        <span class="omni-badge">ESC</span>
                    </div>
                    <div class="omni-results" id="omni-results">
                        <!-- Results injected here -->
                    </div>
                    <div class="omni-footer">
                        <span><i class="fas fa-arrows-alt-v"></i> Navigate</span>
                        <span><i class="fas fa-level-down-alt"></i> Select</span>
                    </div>
                </div>
            </div>



            <!-- PLAYER PROFILE MODAL -->
            <div id="player-profile-modal" class="omni-overlay" onclick="if(event.target===this) closePlayerProfile()">
                <div class="glass-card profile-card-modal">
                    <button class="close-btn" onclick="closePlayerProfile()"><i class="fas fa-times"></i></button>

                    <div class="profile-header">
                        <div class="profile-rank-icon">
                            <img id="pp-rank-img" src="assets/rank_recruit.png" alt="Rank"
                                onerror="handleImageError(this)">
                        </div>
                        <div class="profile-title">
                            <h2 id="pp-username">Player Name</h2>
                            <div id="pp-role" class="profile-role">Role</div>
                        </div>
                    </div>

                    <div class="profile-body">
                        <div class="profile-stats-grid">
                            <div class="p-stat">
                                <span class="label">Total XP</span>
                                <span class="value" id="pp-total-xp">0</span>
                            </div>
                            <div class="p-stat">
                                <span class="label">Total Boss</span>
                                <span class="value" id="pp-total-boss">0</span>
                            </div>
                            <div class="p-stat">
                                <span class="label">Messages</span>
                                <span class="value" id="pp-total-msg">0</span>
                            </div>
                            <div class="p-stat">
                                <span class="label">Days in Clan</span>
                                <span class="value" id="pp-days">0</span>
                            </div>
                        </div>

                        <div class="profile-highlight">
                            <div class="highlight-icon">
                                <img id="pp-skill-img" src="assets/skill_attack.png" alt="Top Skill"
                                    onerror="handleImageError(this, 'boss')">
                            </div>
                            <div class="highlight-text">
                                <div class="label">Est. Top Skill</div>
                                <div class="value" id="pp-top-skill">Unknown</div>
                            </div>
                        </div>

                        <div class="profile-recent">
                            <div class="label">Recent Performance (7d)</div>
                            <div class="recent-row">
                                <span><i class="fas fa-chart-line"></i> XP +<span id="pp-xp-7d">0</span></span>
                                <span><i class="fas fa-skull"></i> Kills +<span id="pp-boss-7d">0</span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>
    </div>
    <script src="dashboard_logic.js?v=1.1"></script>
</body>

</html>