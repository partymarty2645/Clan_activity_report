# ClanStats: OSRS Clan Activity Tracker

## Project Overview

**ClanStats** is a Python-based analytics suite designed to track and visualize Old School RuneScape (OSRS) clan activity. It bridges the gap between in-game progression and community engagement by correlating data from the **Wise Old Man (WOM)** API with **Discord** message activity.

The system is built on a "Process Isolation" architecture, ensuring stability by separating data harvesting, reporting, and dashboard generation into distinct subprocesses.

## Key Features

* **Dual-Source Tracking:** Merges WOM XP/Boss data with Discord engagement metrics (message counts, Q&A tracking).
* **Visual Dashboard:** Generates a static HTML/JS dashboard (`clan_dashboard.html`) deployable to Google Drive, featuring activity heatmaps and boss kill highlights.
* **Excel Reporting:** Produces detailed, conditionally formatted Excel reports (`clan_report_summary_merged.xlsx`).
* **Robust Data Pipeline:** Uses SQLite as a central data bus with Alembic for schema migrations.

## Tech Stack

* **Language:** Python 3.10+
* **Data Sources:** Wise Old Man API, Discord API.
* **Database:** SQLite (with SQLAlchemy ORM & Alembic migrations).
* **Reporting:** `pandas`, `xlsxwriter`.
* **Frontend:** HTML5, JavaScript (Static generation).
* **Key Libraries:** `discord.py`, `requests`, `rich`, `tqdm`.

## Architecture & Workflows

The project orchestrates a pipeline of isolated scripts via `main.py`:

1. **Harvest (`scripts/harvest_sqlite.py`)**:
    * Fetches data from WOM and Discord.
    * Upserts data into the local SQLite database (`clan_data.db`).
2. **Report (`scripts/report_sqlite.py`)**:
    * Queries the database to generate the Excel report.
3. **Export (`scripts/export_sqlite.py`)**:
    * Extracts JSON data (`clan_data.json`) for the frontend.
    * Deploys dashboard assets to the configured Google Drive folder.

## Setup & Usage

### 1. Installation

Run the setup script to create a virtual environment and install dependencies:

```bash
setup.bat
```

### 2. Configuration

Edit the `.env` file generated by setup:

* `WOM_API_KEY`: Your Wise Old Man API key.
* `WOM_GROUP_ID`: Your clan's WOM Group ID.
* `DISCORD_TOKEN`: Discord Bot Token (Message Content Intent required).
* `LOCAL_DRIVE_PATH`: Path to your Google Drive for dashboard hosting.

### 3. Running the Pipeline

To execute the full Harvest -> Report -> Export cycle:

```bash
run_auto.bat
```

Or manually via Python:

```bash
python main.py
```

## Development Conventions

* **Process Isolation:** Do not import heavy logic (like DB connections) at the top level of `main.py`. Use subprocesses to keep steps clean and independent.
* **Database:** Use Alembic for all schema changes. Do not modify the SQLite file structure manually.
* **Assets:** OSRS boss images are stored in `assets/` and referenced by the dashboard generator.
* **Logging:** The orchestrator logs to `app.log`. Check this file for pipeline debugging.
* **Legacy Scripts:** Old verification and one-off scripts are archived in `archive/legacy_scripts`.

## Maintenance

* **Database Optimization:** Handled automatically by `run_auto.bat` (via `scripts/optimize_database.py`).
* **Backups:** Stored in `backups/` before every run.
* **Cleanup:** Use `archive/legacy_scripts` for deprecated logic instead of deleting immediately.
